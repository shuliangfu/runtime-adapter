# @dreamer/runtime-adapter 功能补充分析

## 📋 概述

本文档分析 `@dreamer/runtime-adapter` 库，识别可能缺失的常用兼容功能，并提供实现建议。

---

## ✅ 已实现功能

### 1. 运行时检测 ✅
- `detectRuntime()` - 检测运行时环境
- `IS_DENO`, `IS_BUN`, `RUNTIME` - 运行时常量

### 2. 文件系统 API ✅
- 文件读写：`readFile`, `writeFile`, `readTextFile`, `writeTextFile`
- 文件操作：`open`, `create`, `copyFile`, `rename`, `symlink`, `realPath`
- 目录操作：`mkdir`, `remove`, `readdir`, `stat`, `chmod`, `chown`
- 临时文件：`makeTempDir`, `makeTempFile`
- 工作目录：`cwd`, `chdir`
- 文件监控：`watchFs`

### 3. 网络 API ✅
- HTTP 服务器：`serve`
- WebSocket：`upgradeWebSocket`
- TCP/TLS：`connect`, `startTls`

### 4. 环境变量 API ✅
- `getEnv`, `setEnv`, `deleteEnv`, `getEnvAll`, `hasEnv`

### 5. 进程/命令 API ✅
- `createCommand` - 命令执行

### 6. 终端 API ✅
- TTY 检测：`isTerminal`, `isStderrTerminal`, `isStdinTerminal`
- 标准流：`getStdout`, `getStderr`, `writeStdoutSync`, `writeStderrSync`
- 标准输入：`readStdin`, `setStdinRaw`

### 7. 定时任务 API ✅
- `cron` - Cron 定时任务

### 8. 路径操作 API ✅
- `join`, `dirname`, `basename`, `extname`, `resolve`, `relative`

---

## 🔍 可能缺失的常用功能

### 高优先级（常用且需要兼容）

#### 1. 路径工具函数
**状态**：⚠️ 部分实现

**缺失功能**：
- `normalize(path: string)` - 规范化路径（处理 `.` 和 `..`）
- `isAbsolute(path: string)` - 判断是否为绝对路径
- `isRelative(path: string)` - 判断是否为相对路径

**实现方案**：
```typescript
// 规范化路径
export function normalize(path: string): string {
  // 处理 . 和 .. 路径段
  // 规范化多个斜杠
  // 处理 Windows 路径分隔符
}

// 判断绝对路径
export function isAbsolute(path: string): boolean {
  return path.startsWith("/") || /^[A-Za-z]:/.test(path);
}

// 判断相对路径
export function isRelative(path: string): boolean {
  return !isAbsolute(path);
}
```

**优先级**：高（路径操作常用）

#### 2. 进程信息 API
**状态**：❌ 未实现

**缺失功能**：
- `pid()` - 获取当前进程 ID
- `platform()` - 获取操作系统平台
- `arch()` - 获取 CPU 架构
- `version()` - 获取运行时版本

**实现方案**：
```typescript
// Deno: Deno.pid, Deno.build.os, Deno.build.arch, Deno.version.deno
// Bun: process.pid, process.platform, process.arch, Bun.version
export function pid(): number {
  if (IS_DENO) return (globalThis as any).Deno.pid;
  if (IS_BUN) return (globalThis as any).process?.pid || 0;
  return 0;
}

export function platform(): "linux" | "darwin" | "windows" | "unknown" {
  if (IS_DENO) {
    const os = (globalThis as any).Deno.build.os;
    return os === "darwin" ? "darwin" : os === "windows" ? "windows" : "linux";
  }
  if (IS_BUN) {
    const plat = (globalThis as any).process?.platform;
    return plat === "darwin" ? "darwin" : plat === "win32" ? "windows" : "linux";
  }
  return "unknown";
}
```

**优先级**：高（系统信息常用）

#### 3. 命令行参数和退出 API
**状态**：❌ 未实现（console 库中有，但应该移到 runtime-adapter）

**缺失功能**：
- `args()` - 获取命令行参数
- `exit(code: number)` - 退出程序

**实现方案**：
```typescript
// Deno: Deno.args, Deno.exit
// Bun: process.argv.slice(2), process.exit
export function args(): string[] {
  if (IS_DENO) return (globalThis as any).Deno.args;
  if (IS_BUN) return (globalThis as any).process?.argv?.slice(2) || [];
  return [];
}

export function exit(code: number): never {
  if (IS_DENO) {
    (globalThis as any).Deno.exit(code);
  }
  if (IS_BUN) {
    (globalThis as any).process?.exit(code);
  }
  throw new Error("不支持的运行时环境");
}
```

**优先级**：高（命令行工具常用）

#### 4. 信号处理 API
**状态**：❌ 未实现

**缺失功能**：
- `addSignalListener(signal: string, handler: () => void)` - 添加信号监听
- `removeSignalListener(signal: string, handler: () => void)` - 移除信号监听

**实现方案**：
```typescript
// Deno: Deno.addSignalListener, Deno.removeSignalListener
// Bun: process.on, process.off
export function addSignalListener(
  signal: "SIGTERM" | "SIGINT" | "SIGUSR1" | "SIGUSR2",
  handler: () => void,
): void {
  if (IS_DENO) {
    (globalThis as any).Deno.addSignalListener(signal, handler);
  } else if (IS_BUN) {
    (globalThis as any).process?.on(signal, handler);
  }
}
```

**优先级**：中（优雅关闭常用）

#### 5. 文件扩展功能
**状态**：⚠️ 部分实现

**缺失功能**：
- `truncate(path: string, len: number)` - 截断文件
- `exists(path: string)` - 检查文件/目录是否存在（便捷方法）
- `isFile(path: string)` - 检查是否为文件
- `isDirectory(path: string)` - 检查是否为目录

**实现方案**：
```typescript
// 截断文件
export async function truncate(path: string, len: number): Promise<void> {
  // Deno: Deno.truncate
  // Bun: fs.truncate
}

// 检查存在（便捷方法）
export async function exists(path: string): Promise<boolean> {
  try {
    await stat(path);
    return true;
  } catch {
    return false;
  }
}
```

**优先级**：中（文件操作常用）

### 中优先级（有用但非必需）

#### 6. 目录遍历 API
**状态**：❌ 未实现

**缺失功能**：
- `walk(dir: string, options?)` - 递归遍历目录

**实现方案**：
```typescript
export async function* walk(
  dir: string,
  options?: {
    maxDepth?: number;
    includeFiles?: boolean;
    includeDirs?: boolean;
    match?: (path: string) => boolean;
  },
): AsyncGenerator<string> {
  // 递归遍历目录，返回文件/目录路径
}
```

**优先级**：中（文件操作有用）

#### 7. 文件哈希 API
**状态**：❌ 未实现

**缺失功能**：
- `hashFile(path: string, algorithm?: string)` - 计算文件哈希

**实现方案**：
```typescript
// 使用 Web Crypto API
export async function hashFile(
  path: string,
  algorithm: "SHA-256" | "SHA-512" | "MD5" = "SHA-256",
): Promise<string> {
  const data = await readFile(path);
  const hashBuffer = await crypto.subtle.digest(algorithm, data);
  return Array.from(new Uint8Array(hashBuffer))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}
```

**优先级**：中（文件校验有用）

#### 8. 流操作增强
**状态**：⚠️ 部分实现（有基础流，但缺少工具函数）

**缺失功能**：
- `pipe(source: ReadableStream, dest: WritableStream)` - 管道操作
- `readStream(stream: ReadableStream, size?: number)` - 读取流数据
- `writeStream(stream: WritableStream, data: Uint8Array)` - 写入流数据

**优先级**：低（流操作不常用）

### 低优先级（可选增强）

#### 9. 编码/解码工具
**状态**：❌ 未实现（但可以使用标准 Web API）

**说明**：`TextEncoder` 和 `TextDecoder` 是标准 Web API，Deno 和 Bun 都支持，不需要适配。

**优先级**：低（已有标准 API）

#### 10. URL 操作
**状态**：❌ 未实现（但可以使用标准 Web API）

**说明**：`URL` 和 `URLSearchParams` 是标准 Web API，Deno 和 Bun 都支持，不需要适配。

**优先级**：低（已有标准 API）

#### 11. 随机数/UUID
**状态**：❌ 未实现（但可以使用标准 Web API）

**说明**：
- `Math.random()` 和 `crypto.getRandomValues()` 是标准 Web API
- `crypto.randomUUID()` 是标准 Web API（Deno 2.0+, Bun 1.0+）

**优先级**：低（已有标准 API）

---

## 📊 实现优先级总结

### 高优先级（建议立即实现）
1. ✅ **路径工具函数**：`normalize`, `isAbsolute`, `isRelative`
2. ✅ **进程信息 API**：`pid`, `platform`, `arch`, `version`
3. ✅ **命令行参数和退出 API**：`args`, `exit`
4. ✅ **信号处理 API**：`addSignalListener`, `removeSignalListener`

### 中优先级（建议后续实现）
5. ⚠️ **文件扩展功能**：`truncate`, `exists`, `isFile`, `isDirectory`
6. ⚠️ **目录遍历 API**：`walk`
7. ⚠️ **文件哈希 API**：`hashFile`

### 低优先级（可选）
8. 流操作增强
9. 编码/解码工具（已有标准 API）
10. URL 操作（已有标准 API）
11. 随机数/UUID（已有标准 API）

---

## 🎯 建议实现顺序

1. **第一阶段**：路径工具函数（高优先级，使用频繁）
2. **第二阶段**：进程信息 API（高优先级，系统信息常用）
3. **第三阶段**：命令行参数和退出 API（高优先级，命令行工具常用）
4. **第四阶段**：信号处理 API（高优先级，优雅关闭常用）
5. **第五阶段**：文件扩展功能（中优先级，文件操作常用）
6. **第六阶段**：目录遍历和文件哈希（中优先级，特定场景有用）

---

## 📝 注意事项

1. **标准 Web API**：`TextEncoder`, `TextDecoder`, `URL`, `URLSearchParams`, `crypto.randomUUID()` 等都是标准 Web API，Deno 和 Bun 都原生支持，不需要在 runtime-adapter 中实现。

2. **平台差异**：某些功能在 Deno 和 Bun 中的实现方式可能不同，需要仔细适配。

3. **向后兼容**：添加新功能时，需要确保不影响现有功能。

4. **测试覆盖**：新功能需要添加完整的测试用例，确保在 Deno 和 Bun 环境下都能正常工作。
